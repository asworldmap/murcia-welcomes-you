<div class="container" style="padding-top: 100px;">
    <div style="text-align: center; margin-bottom: 60px;">
        <h1 class="animate-title" style="font-size: 3.5rem; color: var(--primary);">Join the Family</h1>
        <p class="animate-subtitle" style="font-size: 1.2rem; max-width: 600px; margin: 0 auto;">Everything you need to
            reset and enjoy January in Murcia.</p>
    </div>

    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px;">
        <% plans.forEach(plan=> { %>
            <div class="pricing-card <%= plan.popular ? 'popular' : '' %> animate-card" style="margin: 0;">
                <% if (plan.popular) { %>
                    <div class="popular-badge">Most Loved</div>
                    <% } %>
                        <h2 style="color: var(--naif-orange);">
                            <%= plan.name %>
                        </h2>
                        <div class="price">
                            <%= plan.price %>€
                        </div>
                        <ul style="list-style: none; margin: 30px 0; padding: 0; text-align: left;">
                            <% plan.features.forEach(feature=> { %>
                                <li style="margin-bottom: 12px;">✨ <%= feature %>
                                </li>
                                <% }) %>
                        </ul>

                        <button onclick="payWithStripe('<%= plan.id %>')" class="btn stripe-btn"
                            style="width: 100%; margin-bottom: 15px;">Pay with Card</button>
                        <div id="paypal-button-container-<%= plan.id %>" class="paypal-btn-container"></div>
            </div>
            <% }) %>
    </div>
</div>

<!-- Dynamic Widget: Live Member Counter -->
<div class="live-widget animate-widget">
    <span class="pulse"></span>
    <span id="member-count">47</span> members joined today!
</div>

<style>
    .pricing-card.popular {
        border-color: var(--naif-pink);
        transform: scale(1.05);
    }

    .popular-badge {
        background: var(--naif-pink);
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 700;
        position: absolute;
        top: -15px;
        left: 50%;
        transform: translateX(-50%);
    }

    .live-widget {
        position: fixed;
        bottom: 30px;
        left: 30px;
        background: white;
        padding: 15px 25px;
        border-radius: 50px;
        box-shadow: var(--shadow);
        z-index: 100;
        border: 2px solid var(--naif-mint);
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 700;
    }

    .pulse {
        width: 10px;
        height: 10px;
        background: #4CAF50;
        border-radius: 50%;
        display: inline-block;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7);
        }

        70% {
            box-shadow: 0 0 0 10px rgba(76, 175, 80, 0);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
        }
    }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
<script src="https://www.paypal.com/sdk/js?client-id=sb&currency=EUR"></script>
<script>
    // GSAP Animations
    gsap.from(".animate-title", { opacity: 0, y: -50, duration: 1, ease: "back" });
    gsap.from(".animate-subtitle", { opacity: 0, y: -20, delay: 0.3, duration: 1 });
    gsap.from(".animate-card", { opacity: 0, scale: 0.8, stagger: 0.2, delay: 0.5, duration: 0.8, ease: "power2.out" });
    gsap.from(".animate-widget", { x: -100, opacity: 0, delay: 1.5, duration: 1, ease: "power4.out" });

    // Live counter effect
    setInterval(() => {
        const count = document.getElementById('member-count');
        if (Math.random() > 0.7) {
            let current = parseInt(count.innerText);
            count.innerText = current + 1;
            gsap.from(count, { scale: 1.5, color: "#9b5de5", duration: 0.5 });
        }
    }, 5000);

    function payWithStripe(planId) {
        fetch('/create-checkout-session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ planId })
        })
            .then(res => res.json())
            .then(data => { if (data.url) window.location.href = data.url; })
            .catch(err => console.error('Stripe Error:', err));
    }

    // PayPal Buttons for each plan
    <% plans.forEach(plan => { %>
        paypal.Buttons({
            createOrder: (data, actions) => actions.order.create({
                purchase_units: [{ amount: { value: '<%= plan.price %>.00' } }]
            }),
            onApprove: (data, actions) => actions.order.capture().then(() => window.location.href = '/success')
        }).render('#paypal-button-container-<%= plan.id %>');
    <% }) %>
</script>