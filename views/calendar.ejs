<div class="container" style="padding-top: var(--space-6);">
    <div style="text-align: center; margin-bottom: var(--space-8);">
        <h1 style="font-size: 3.5rem; margin-bottom: var(--space-2);">Calendar</h1>
        <p style="color: var(--text-soft); font-size: 1.1rem;">Join the vibe. Discover upcoming activities in Murcia.
        </p>
    </div>

    <!-- This Week Quick Links -->
    <div style="margin-bottom: var(--space-8);">
        <h3 style="margin-bottom: var(--space-4);">Happening Soon</h3>
        <div class="grid" style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));">
            <% const now=new Date(); const soon=events.filter(e=> new Date(e.date) >= now).slice(0, 3);
                %>
                <% soon.forEach(event=> { %>
                    <a href="/event/<%= event.id %>" class="card"
                        style="display: flex; flex-direction: column; gap: var(--space-3); padding: var(--space-4);">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <span style="font-size: 2rem;">
                                <%= event.emoji %>
                            </span>
                            <span class="badge badge-primary">
                                <%= event.category %>
                            </span>
                        </div>
                        <div>
                            <h4 style="font-size: 1.1rem;">
                                <%= event.name %>
                            </h4>
                            <p style="font-size: 0.9rem; color: var(--text-soft);">
                                <%= event.date %> @ <%= event.time %>
                            </p>
                        </div>
                        <div
                            style="display: flex; align-items: center; gap: var(--space-2); font-size: 0.85rem; font-weight: 700; color: var(--primary);">
                            View Details →
                        </div>
                    </a>
                    <% }) %>
        </div>
    </div>

    <div class="calendar-controls">
        <div class="toggle-group" id="viewToggle">
            <button class="toggle-btn active" data-view="month">Month</button>
            <button class="toggle-btn" data-view="agenda">Agenda</button>
        </div>

        <div style="display: flex; gap: var(--space-2);">
            <select id="categoryFilter" style="width: auto; padding-right: var(--space-6);">
                <option value="all">All Categories</option>
                <option value="Outdoor">Outdoor</option>
                <option value="Fitness">Fitness</option>
                <option value="Dance">Dance</option>
                <option value="Tech">Tech</option>
                <option value="Social">Social</option>
            </select>
        </div>
    </div>

    <!-- Month View -->
    <div id="monthView" class="month-grid">
        <% const days=['Mon', 'Tue' , 'Wed' , 'Thu' , 'Fri' , 'Sat' , 'Sun' ]; days.forEach(day=> { %>
            <div class="day-header">
                <%= day %>
            </div>
            <% }) %>

                <% // Simplified grid generation for Jan 2026 // Starts on Wed (Jan 1) const emptyCellsBefore=2; // Mon,
                    Tue for(let i=0; i<emptyCellsBefore; i++) { %>
                    <div class="day-cell muted"></div>
                    <% } for(let day=1; day<=31; day++) { const dateStr=`2026-01-${day.toString().padStart(2, '0' )}`;
                        const dayEvents=events.filter(e=> e.date === dateStr);
                        %>
                        <div class="day-cell">
                            <div class="day-num">
                                <%= day %>
                            </div>
                            <% dayEvents.forEach(event=> { %>
                                <a href="/event/<%= event.id %>" class="event-chip" title="<%= event.name %>"
                                    data-category="<%= event.category %>">
                                    <span>
                                        <%= event.emoji %>
                                    </span>
                                    <span style="overflow: hidden; text-overflow: ellipsis;">
                                        <%= event.name.split('·')[0].trim() %>
                                    </span>
                                </a>
                                <% }) %>
                        </div>
                        <% } %>
    </div>

    <!-- Agenda View (Hidden by default on desktop, shown on mobile) -->
    <div id="agendaView" class="agenda-view" style="display: none;">
        <% // Group events by date const groupedEvents={}; events.forEach(e=> {
            const d = new Date(e.date).toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long' });
            if(!groupedEvents[d]) groupedEvents[d] = [];
            groupedEvents[d].push(e);
            });

            Object.keys(groupedEvents).forEach(date => {
            %>
            <div class="agenda-day" data-categories="<%= groupedEvents[date].map(e => e.category).join(',') %>">
                <div class="agenda-date">
                    <%= date %>
                </div>
                <% groupedEvents[date].forEach(event=> { %>
                    <a href="/event/<%= event.id %>" class="agenda-item" data-category="<%= event.category %>">
                        <div class="agenda-time">
                            <%= event.time %>
                        </div>
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: var(--space-2);">
                                <span style="font-size: 1.25rem;">
                                    <%= event.emoji %>
                                </span>
                                <h4 style="font-size: 1rem;">
                                    <%= event.name %>
                                </h4>
                                <span class="badge badge-primary" style="margin-left: auto;">
                                    <%= event.category %>
                                </span>
                            </div>
                        </div>
                    </a>
                    <% }) %>
            </div>
            <% }) %>
    </div>
</div>

<script>
    const viewToggle = document.getElementById('viewToggle');
    const monthView = document.getElementById('monthView');
    const agendaView = document.getElementById('agendaView');
    const categoryFilter = document.getElementById('categoryFilter');

    // Toggle logic
    viewToggle.addEventListener('click', (e) => {
        if (!e.target.classList.contains('toggle-btn')) return;

        const view = e.target.dataset.view;
        document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
        e.target.classList.add('active');

        if (view === 'month') {
            monthView.style.display = 'grid';
            agendaView.style.display = 'none';
        } else {
            monthView.style.display = 'none';
            agendaView.style.display = 'block';
        }
    });

    // Filter logic
    categoryFilter.addEventListener('change', () => {
        const cat = categoryFilter.value;

        // Filter chips in Month view
        document.querySelectorAll('.event-chip').forEach(chip => {
            if (cat === 'all' || chip.dataset.category === cat) {
                chip.style.display = 'flex';
            } else {
                chip.style.display = 'none';
            }
        });

        // Filter items in Agenda view
        document.querySelectorAll('.agenda-item').forEach(item => {
            if (cat === 'all' || item.dataset.category === cat) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });

        // Hide agenda days if no items visible
        document.querySelectorAll('.agenda-day').forEach(day => {
            const hasVisible = Array.from(day.querySelectorAll('.agenda-item')).some(i => i.style.display !== 'none');
            day.style.display = hasVisible ? 'block' : 'none';
        });
    });

    // Mobile specific: show items automatically
    if (window.innerWidth <= 768) {
        document.querySelector('[data-view="agenda"]').click();
    }
</script>